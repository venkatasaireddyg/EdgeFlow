# EdgeFlow Development Agents & Rules

## CRITICAL RULES - MUST BE FOLLOWED

### Rule 1: CLI-API Parity (STRICTLY ENFORCED)

Every CLI command MUST have a corresponding API endpoint. NO EXCEPTIONS.

| CLI Command | API Endpoint | Status |
|------------|--------------|--------|
| `python edgeflowc.py config.ef` | `POST /api/compile` | ✅ |
| `python edgeflowc.py config.ef --verbose` | `POST /api/compile/verbose` | ✅ |
| `python edgeflowc.py config.ef --dry-run` | `POST /api/compile/dry-run` | ✅ |
| `python edgeflowc.py --version` | `GET /api/version` | ✅ |
| `python edgeflowc.py --help` | `GET /api/help` | ✅ |
| `python edgeflowc.py config.ef --check-only` | `POST /api/check` | ✅ |

Enforcement:

- PR will be REJECTED if CLI functionality exists without API endpoint
- PR will be REJECTED if API endpoint exists without CLI equivalent (except /health)

### Rule 2: Pre-PR Checklist (MANDATORY)

Before raising ANY PR:

- [ ] Run `make lint-backend` - MUST PASS
- [ ] Run `make lint-frontend` - MUST PASS
- [ ] Run `make test-backend` - MUST PASS (target ≥90% coverage)
- [ ] Run `make test-frontend` - MUST PASS (target ≥80% coverage)
- [ ] Run `make pre-commit` - ALL CHECKS MUST PASS
- [ ] Update API documentation if endpoints changed
- [ ] Update Agents.md if new CLI commands added

### Rule 4: CD Pipeline (PROD-ONLY)

- Deployment runs on `push` to `main` or manual dispatch.
- Build images to GHCR; deploy over SSH with Docker Compose on the server.
- Required Secrets: `SSH_HOST`, `SSH_USER`, `SSH_PRIVATE_KEY` (optionally `SSH_PASSPHRASE`).
- Optional Secrets for private registries: `GHCR_USERNAME`, `GHCR_TOKEN` (read:packages).
- Default host ports: Backend `18000`, Frontend `13000` (change in `docker-compose.prod.yml`).
- Do NOT commit secrets; lockfiles MUST be committed (e.g., `frontend/package-lock.json`).

Evidence Required in PR:
```
make pre-commit
```

### Rule 3: Documentation Requirements

Every PR must include:

1. Updated OpenAPI spec (auto-generated by FastAPI)
2. Updated README if user-facing changes
3. Docstrings/JSDoc for all new functions
4. Updated Agents.md for new features

## Development Agents

### Backend Agent

- Maintains API server
- Ensures CLI wrapper functions work correctly
- Responsible for backend tests
- Reviews: API design, security, performance

### Frontend Agent

- Maintains UI components
- Ensures API integration works
- Responsible for frontend tests
- Reviews: UX, accessibility, browser compatibility

### Integration Agent

- Maintains docker-compose setup
- Ensures frontend-backend communication
- Responsible for E2E tests
- Reviews: System integration, deployment

## Workflow

1. Feature development

```
git checkout -b feature/your-feature
# Make changes
make pre-commit  # MUST PASS
git add .
git commit -m "feat: your feature"
git push origin feature/your-feature
```

2. PR Template

```
## Changes
- [ ] Added CLI command: `___`
- [ ] Added API endpoint: `___`
- [ ] CLI-API parity maintained
 - [ ] If web changes: Tailwind styles updated and tested

## Testing
- [ ] Backend tests pass
- [ ] Frontend tests pass
- [ ] E2E tests pass
- [ ] Pre-commit checks pass

## Evidence
```
make pre-commit
```
```

## CD Runbook

- Pipeline: `.github/workflows/cd.yml`
- Server path: `/opt/edgeflow`
- Compose file: `docker-compose.yml` (deployed from `docker-compose.prod.yml`)
- To change ports: edit `docker-compose.prod.yml` and update health checks in the workflow if host ports change.
- Rollout logic: stop existing stack, free named containers/network, pull, force-recreate, health checks.
- Logs on server:
  - `docker compose -p edgeflow -f /opt/edgeflow/docker-compose.yml ps`
  - `docker compose -p edgeflow -f /opt/edgeflow/docker-compose.yml logs -f backend`
  - `docker compose -p edgeflow -f /opt/edgeflow/docker-compose.yml logs -f frontend`

## Monitoring

Dashboard tracking:

- CLI commands without API endpoints: 0 (MUST be 0)
- API endpoints without CLI commands: 1 (/health only)
- Test coverage: Backend >90%, Frontend >80%
- Lint violations: 0
